{% extends 'base.html' %}

{% block head %}
<title>{{ name }}</title>
<style>
    /* Additional styles for file preview modal */
    .modal-dialog {
        max-width: 90%;
    }
    .modal-content {
        max-height: 90vh;
        overflow: hidden;
    }
    .modal-body {
        text-align: center;
    }
    .modal-body img,
    .modal-body video {
        max-width: 100%;
        max-height: calc(100vh - 200px);
        margin: auto;
        display: block;
    }
</style>
{% endblock %}

{% block body %}
<nav aria-label="breadcrumb" style="overflow: scroll;">
    <ol class="breadcrumb mt-2">
        {% for item in locations %}
            <li class="breadcrumb-item"><a href="/folder/{{ item.id }}">{{ item.name }}</a></li>
        {% endfor %}
    </ol>
</nav>

<main class="container">
    <!-- Folders Section -->
    <section class="folders-section mb-4">
        <h3>Folders ({{ num_folders }})</h3>
        <div class="g-container">
            {% if folders %}
                {% for item in folders %}
                <ul class="list-group m-3 shadow flex-row align-items-center">
                    <a href="/folder/{{ item.id }}" class="list-group-item list-group-item-action d-flex align-items-center text-decoration-none text-reset border-0">
                        <i class="fa-solid fa-folder me-3" style="font-size: 2rem;"></i>
                        <div>
                            <p class="text-body-primary mb-0">{{ item.name }}</p>
                            <small class="text-body-secondary">{{ item.created.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                    </a>
                    <i class="fa-solid fa-link mx-2" onclick="copyLink('/folder/{{ item.id }}')"></i>
                </ul>
                {% endfor %}
            {% else %}
                <p>No folders available.</p>
            {% endif %}
        </div>
    </section>

    <!-- Files Section -->
    <section class="files-section">
        <h3>Files ({{ num_files }})</h3>
        <div class="g-container">
            {% if files %}
                {% for item in files %}
                <ul class="list-group m-3 shadow flex-row align-items-center border">
                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center text-decoration-none text-reset border-0 preview-file"
                       data-file-name="{{ item.name }}"
                       data-file-url="/file/{{ item.id }}">
                        {% set image_extensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'] %}
                        {% set video_extensions = ['mp4', 'mov', 'avi', 'mkv', 'flv', 'wmv', 'webm'] %}
                        {% set document_extensions = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'txt'] %}
                        {% set file_extension = item.name.split('.')[-1].lower() %}
                        
                        {% if file_extension in image_extensions %}
                            <i class="fa-solid fa-image me-3" style="font-size: 2rem;"></i>
                        {% elif file_extension in video_extensions %}
                            <i class="fa-solid fa-video me-3" style="font-size: 2rem;"></i>
                        {% elif file_extension in document_extensions %}
                            <i class="fa-solid fa-file-alt me-3" style="font-size: 2rem;"></i>
                        {% else %}
                            <i class="fa-solid fa-file me-3" style="font-size: 2rem;"></i>
                        {% endif %}
                        
                        <div>
                            <p class="text-body-primary mb-0">{{ item.name }}</p>
                            <small class="text-body-secondary">{{ item.created.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                    </a>
                    <li class="list-group-item border-0 p-0">
                        <div class="dropdown">
                            <i class="fa-solid fa-ellipsis-vertical px-3" style="font-size: 1.5rem;" id="dropdownMenuButton{{ item.id }}" data-bs-toggle="dropdown" aria-expanded="false"></i>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ item.id }}">
                                <li>
                                    <a class="dropdown-item d-flex align-items-center" href="/file/{{ item.id }}">
                                        <i class="fa-solid fa-download me-2"></i> Download
                                    </a>
                                </li>
                                <li>
                                    <button class="dropdown-item d-flex align-items-center" onclick="copyLink('/file/{{ item.id }}')">
                                        <i class="fa-solid fa-link me-2"></i> Copy Link
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>                
                {% endfor %}
            {% else %}
                <p>No files available.</p>
            {% endif %}
        </div>
    </section>
</main>

<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-body">
                <!-- Content will be dynamically added here based on the file type -->
            </div>
        </div>
    </div>
</div>

<script>
    async function copyLink(path) {
        try {
            await navigator.clipboard.writeText(window.location.origin + path);
        } catch (err) {
            alert('Failed to copy the link: ', err);
        }
    }

    // Function to open file preview modal
    function openFilePreview(fileType, fileName, fileUrl) {
        fileType = get_file_type(fileName)

        var modalBody = document.querySelector('.modal-body');
        modalBody.innerHTML = ''; // Clear previous content

        if (fileType === 'image') {
            var img = document.createElement('img');
            img.src = fileUrl;
            img.alt = fileName;
            modalBody.appendChild(img);
        } else if (fileType === 'video') {
            var video = document.createElement('video');
            video.controls = true;
            var source = document.createElement('source');
            source.src = fileUrl;
            source.type = 'video/mp4'; // Adjust according to video type
            video.appendChild(source);
            modalBody.appendChild(video);
        } else {
            // Handle other file types or fallback to generic message
            modalBody.textContent = 'Preview not available for this file type.';
        }

        // Open the modal
        var filePreviewModal = new bootstrap.Modal(document.getElementById('filePreviewModal'), {
            keyboard: true
        });
        filePreviewModal.show();
    }

    // Attach click event to preview-file links
    document.addEventListener('DOMContentLoaded', function () {
        var previewLinks = document.querySelectorAll('.preview-file');
        previewLinks.forEach(function (link) {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                var fileType = this.getAttribute('data-file-type');
                var fileName = this.getAttribute('data-file-name');
                var fileUrl = this.getAttribute('data-file-url');
                openFilePreview(fileType, fileName, fileUrl);
            });
        });
    });

    // Function to get file type based on extension
    function get_file_type(filename) {
        var ext = filename.split('.').pop().toLowerCase();
        if (['gif', 'png', 'jpg', 'jpeg', 'bmp', 'svg', 'webp'].includes(ext)) {
            return 'image';
        } else if (['mp4', 'mov', 'avi', 'mkv', 'flv', 'wmv', 'webm'].includes(ext)) {
            return 'video';
        } else {
            return 'other';
        }
    }
</script>
{% endblock %}
